#!/usr/bin/env watchr

require 'fileutils'

CODE = 'app/assets/javascripts'
OUTPUT = '.js'

Signal.trap 'EXIT' do
  FileUtils.rm_rf OUTPUT
  clean_up()
  puts ''
  puts 'I knew you didnt care about me! NOW I\'M GOING TO DELETE SHIT...'
end

def clean_up
  Dir.glob('docs/js/coverage/*.json').each { |f| File.delete(f) }
end

def sync_all
  print "Syncing all files... "
  system( "rsync -a --include='*.js' --include='*.dust' --include='*/' --exclude='*' #{CODE}/ #{OUTPUT}/" )
  puts "DONE"
end

def sync_js
  print "JS changes detected! Syncing files... "
  system( "rsync -a --include='*.js' --include='*/' --exclude='*' #{CODE}/ #{OUTPUT}/" )
  puts "DONE"
end

def sync_dust
  print "Dust changes detected! Syncing files... "
  system( "rsync -a --include='*.dust' --include='*/' --exclude='*' #{CODE}/ #{OUTPUT}/" )
  puts "DONE"
end

def compile_coffee
  print "CoffeeScript changes detected! Compiling files... "
  system( "coffee -co #{OUTPUT} #{CODE}" )
  puts "DONE"
end

def update_docs
  print "Updating Docco docs..."
  system( "docco #{CODE}**/*.coffee -o docs/js > /dev/null" )
  puts "DONE"
end

def start_karma
  system( "karma start karma.conf.js --no-auto-watch > /dev/null &" )
end

def run_karma
  system( "karma run karma.conf.js" )
end

def create_directory
  unless File.exists? OUTPUT
    print "Creating temp directory..."
    Dir::mkdir OUTPUT
    puts "DONE"
  end
end

def watch_all
  watch("#{CODE}/.*\.(js|dust|coffee|litcoffee)$") do |path|
    path = "#{path}"
    path.slice! CODE
    puts "#{path} modified"
  end
  watch("#{CODE}/.*\.js$") do
    sync_js()
    sleep 1
    run_karma()
  end
  watch("#{CODE}/.*\.dust$") do
    sync_dust()
  end
  watch("#{CODE}/.*\.(coffee|litcoffee)$") do
    compile_coffee()
    update_docs()
    sleep 1
    run_karma()
  end
end

def init
  create_directory()
  sync_all()
  watch_all()
  start_karma()
end

init()

